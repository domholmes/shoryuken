<html>
<head>
  <title>Login</title>
  <script type="text/javascript">
      (function () {
          var po = document.createElement('script');
          po.type = 'text/javascript'; po.async = true;
          po.src = 'https://plus.google.com/js/client:plusone.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(po, s);
      })();
  </script>
  <!-- JavaScript specific to this application that is not related to API
     calls -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" ></script>
</head>
<body>
  <div id="gConnect">
    <button class="g-signin"
        data-scope="https://www.googleapis.com/auth/plus.login"
        data-requestvisibleactions="http://schemas.google.com/AddActivity"
        data-clientId=@ViewBag.ClientId
        data-accesstype="offline"
        data-callback="onSignInCallback"
        data-theme="dark"
        data-cookiepolicy="single_host_origin">
    </button>
  </div>
</body>
<script type="text/javascript">
    var helper = (function () {
        var authResult = undefined;

        return {

            onSignInCallback: function (authResult) {
                $('#authResult').html('Auth Result:<br/>');
                for (var field in authResult) {
                    $('#authResult').append(' ' + field + ': ' + authResult[field] + '<br/>');
                }
                if (authResult['access_token']) {
                    // The user is signed in
                    this.authResult = authResult;
                    // After we load the Google+ API, render the profile data from Google+.
                    gapi.client.load('plus', 'v1', this.renderProfile);
                }
            },

            renderProfile: function () {
                var request = gapi.client.plus.people.get({ 'userId': 'me' });
                request.execute(function (profile) {
                    $('#profile').empty();
                    if (profile.error) {
                        $('#profile').append(profile.error);
                        return;
                    }
                    helper.connectServer(profile.id);
                });
                $('#gConnect').hide();
            },

            connectServer: function (gplusId) {
                $.ajax({
                    type: 'POST',
                    url: '/Account/Callback',
                    data: { gplusId: gplusId, code: this.authResult.code },
                    success: function () {
                            window.location.href = '@ViewBag.ReturnUrl';
                    }
                });
            }
        };
    })();

function onSignInCallback(authResult) {
  helper.onSignInCallback(authResult);
}
</script>
</html>
